name: Create Tag Release
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true

jobs:
  print-tag:
    name: Print Tag
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Print Tag
      run: echo "Creating tag ${{ github.event.inputs.tag }}"

  create-tag:
    name: Create tag
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        ref: 'main'
    - uses: chrisdickinson/setup-yq@latest
      with:
        yq-version: v4.43.1
        yq-url: https://github.com/mikefarah/yq/releases/download/{version}/yq_{platform}_{arch}
    - name:
      run: |
        git checkout -b ${{ github.event.inputs.tag }}
        yq e -i '.services.grafana.image = "lorenzodagostino/ui-cities:${{ github.event.inputs.tag }}"' compose-app.yaml
        yq e -i '.services.app.image = "lorenzodagostino/cityservice:${{ github.event.inputs.tag }}"' compose-app.yaml
    - name: Commit changes
      run: |
        git config --local user.email github-actions@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git add .
        git commit -m "Update compose-app.yaml"
    - name: Create tag
      env:
        token: ${{ secrets.PAT }}
      run: |
        git tag ${{ github.event.inputs.tag }}
        git push origin tag ${{ github.event.inputs.tag }}
